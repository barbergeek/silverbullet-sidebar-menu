var q=Object.defineProperty;var f=(e,r)=>{for(var n in r)q(e,n,{get:r[n],enumerable:!0})};var m=e=>{throw new Error("Not initialized yet")},S=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var w=new Map,T=0;S&&(globalThis.syscall=async(e,...r)=>await new Promise((n,o)=>{T++,w.set(T,{resolve:n,reject:o}),m({type:"sys",id:T,name:e,args:r})}));function E(e,r,n){S&&(m=n,self.addEventListener("message",o=>{(async()=>{let i=o.data;switch(i.type){case"inv":{let a=e[i.name];if(!a)throw new Error(`Function not loaded: ${i.name}`);try{let s=await Promise.resolve(a(...i.args||[]));m({type:"invr",id:i.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",i.name,"error:",s.message),m({type:"invr",id:i.id,error:s.message})}}break;case"sysr":{let a=i.id,s=w.get(a);if(!s)throw Error("Invalid request id");w.delete(a),i.error?s.reject(new Error(i.error)):s.resolve(i.result)}break}})().catch(console.error)}),m({type:"manifest",manifest:r}))}function $(e){let r=atob(e),n=r.length,o=new Uint8Array(n);for(let i=0;i<n;i++)o[i]=r.charCodeAt(i);return o}function O(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let r="",n=e.byteLength;for(let o=0;o<n;o++)r+=String.fromCharCode(e[o]);return btoa(r)}async function j(e,r){if(typeof e!="string"){let n=new Uint8Array(await e.arrayBuffer()),o=n.length>0?O(n):void 0;r={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:o},e=e.url}return syscall("sandboxFetch.fetch",e,r)}globalThis.nativeFetch=globalThis.fetch;function X(){globalThis.fetch=async function(e,r){let n=r&&r.body?O(new Uint8Array(await new Response(r.body).arrayBuffer())):void 0,o=await j(e,r&&{method:r.method,headers:r.headers,base64Body:n});return new Response(o.base64Body?$(o.base64Body):null,{status:o.status,headers:o.headers})}}S&&X();var l={};f(l,{confirm:()=>ve,copyToClipboard:()=>Ue,deleteLine:()=>Le,dispatch:()=>xe,downloadFile:()=>ce,filterBox:()=>ue,flashNotification:()=>de,fold:()=>Se,foldAll:()=>ke,getCurrentPage:()=>Q,getCursor:()=>G,getSelection:()=>z,getText:()=>_,getUiOption:()=>Te,goHistory:()=>ae,hidePanel:()=>fe,insertAtCursor:()=>he,insertAtPos:()=>me,moveCursor:()=>ye,moveCursorToLine:()=>Pe,navigate:()=>Z,newWindow:()=>se,openCommandPalette:()=>re,openPageNavigator:()=>ee,openSearchPanel:()=>Fe,openUrl:()=>ie,prompt:()=>be,redo:()=>Oe,reloadConfigAndCommands:()=>oe,reloadPage:()=>te,reloadUI:()=>ne,replaceRange:()=>ge,save:()=>J,setSelection:()=>Y,setText:()=>V,setUiOption:()=>we,showPanel:()=>pe,toggleFold:()=>Ce,undo:()=>Ee,unfold:()=>Ae,unfoldAll:()=>Me,uploadFile:()=>le,vimEx:()=>Be});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function t(e,...r){return globalThis.syscall(e,...r)}function Q(){return t("editor.getCurrentPage")}function _(){return t("editor.getText")}function V(e,r=!1){return t("editor.setText",e,r)}function G(){return t("editor.getCursor")}function z(){return t("editor.getSelection")}function Y(e,r){return t("editor.setSelection",e,r)}function J(){return t("editor.save")}function Z(e,r=!1,n=!1){return t("editor.navigate",e,r,n)}function ee(e="page"){return t("editor.openPageNavigator",e)}function re(){return t("editor.openCommandPalette")}function te(){return t("editor.reloadPage")}function ne(){return t("editor.reloadUI")}function oe(){return t("editor.reloadConfigAndCommands")}function ie(e,r=!1){return t("editor.openUrl",e,r)}function se(){return t("editor.newWindow")}function ae(e){return t("editor.goHistory",e)}function ce(e,r){return t("editor.downloadFile",e,r)}function le(e,r){return t("editor.uploadFile",e,r)}function de(e,r="info"){return t("editor.flashNotification",e,r)}function ue(e,r,n="",o=""){return t("editor.filterBox",e,r,n,o)}function pe(e,r,n,o=""){return t("editor.showPanel",e,r,n,o)}function fe(e){return t("editor.hidePanel",e)}function me(e,r){return t("editor.insertAtPos",e,r)}function ge(e,r,n){return t("editor.replaceRange",e,r,n)}function ye(e,r=!1){return t("editor.moveCursor",e,r)}function Pe(e,r=1,n=!1){return t("editor.moveCursorToLine",e,r,n)}function he(e){return t("editor.insertAtCursor",e)}function xe(e){return t("editor.dispatch",e)}function be(e,r=""){return t("editor.prompt",e,r)}function ve(e){return t("editor.confirm",e)}function Te(e){return t("editor.getUiOption",e)}function we(e,r){return t("editor.setUiOption",e,r)}function Se(){return t("editor.fold")}function Ae(){return t("editor.unfold")}function Ce(){return t("editor.toggleFold")}function ke(){return t("editor.foldAll")}function Me(){return t("editor.unfoldAll")}function Ee(){return t("editor.undo")}function Oe(){return t("editor.redo")}function Fe(){return t("editor.openSearchPanel")}function Ue(e){return t("editor.copyToClipboard",e)}function Le(){return t("editor.deleteLine")}function Be(e){return t("editor.vimEx",e)}var P={};f(P,{parseMarkdown:()=>Re,renderParseTree:()=>Ne});function Re(e){return t("markdown.parseMarkdown",e)}function Ne(e){return t("markdown.renderParseTree",e)}var h={};f(h,{applyAttributeExtractors:()=>$e,getEnv:()=>_e,getMode:()=>Ve,getSpaceConfig:()=>je,getVersion:()=>Ge,invokeCommand:()=>He,invokeFunction:()=>We,invokeSpaceFunction:()=>qe,listCommands:()=>Ke,listSyscalls:()=>Ie,reloadConfig:()=>Qe,reloadPlugs:()=>Xe});function We(e,...r){return t("system.invokeFunction",e,...r)}function He(e,r){return t("system.invokeCommand",e,r)}function Ke(){return t("system.listCommands")}function Ie(){return t("system.listSyscalls")}function qe(e,...r){return t("system.invokeSpaceFunction",e,...r)}function $e(e,r,n){return t("system.applyAttributeExtractors",e,r,n)}async function je(e,r){return await t("system.getSpaceConfig",e)??r}function Xe(){return t("system.reloadPlugs")}function Qe(){return t("system.reloadConfig")}function _e(){return t("system.getEnv")}function Ve(){return t("system.getMode")}function Ge(){return t("system.getVersion")}var g={};f(g,{del:()=>Je,get:()=>Ye,set:()=>ze});function ze(e,r){return t("clientStore.set",e,r)}function Ye(e){return t("clientStore.get",e)}function Je(e){return t("clientStore.delete",e)}var x={};f(x,{readAsset:()=>ir});function or(e){let r=atob(e),n=r.length,o=new Uint8Array(n);for(let i=0;i<n;i++)o[i]=r.charCodeAt(i);return o}function F(e){let r=e.split(",",2)[1];return or(r)}async function ir(e,r,n="utf8"){let o=await t("asset.readAsset",e,r);switch(n){case"utf8":return new TextDecoder().decode(F(o));case"dataurl":return o}}function A(e,r){if(r(e))return[e];let n=[];if(e.children)for(let o of e.children)n=[...n,...A(o,r)];return n}function y(e,r){return A(e,n=>n.type===r)[0]}function U(e,r){A(e,r)}function b(e){if(!e)return"";let r=[];if(e.text!==void 0)return e.text;for(let n of e.children)r.push(b(n));return r.join("")}function C(e){if(e.type?.endsWith("Mark")||e.type?.endsWith("Delimiter"))return"";let r=n=>n.map(C).join("");switch(e.type){case"Document":case"Emphasis":case"Highlight":case"Strikethrough":case"InlineCode":case"StrongEmphasis":case"Superscript":case"Subscript":case"Paragraph":case"ATXHeading1":case"ATXHeading2":case"ATXHeading3":case"ATXHeading4":case"ATXHeading5":case"ATXHeading6":case"Blockquote":case"BulletList":case"OrderedList":case"ListItem":case"Table":case"TableHeader":case"TableCell":case"TableRow":case"Task":case"HTMLTag":return r(e.children);case"FencedCode":case"CodeBlock":return e.children=e.children.filter(n=>n.type),r(e.children);case"Link":{let n=e.children.slice(1,-4);return r(n)}case"Image":{let n=y(e,"WikiLinkAlias")||e.children[1],o=n&&n.type!=="LinkMark"?b(n):"<Image>",i=/\d*[^\|\s]*?[xX]\d*[^\|\s]*/.exec(o);return i&&(o=o.replace(i[0],"").replace("|","")),o}case"WikiLink":{let n=y(e,"WikiLinkAlias"),o;return n?o=n.children[0].text:o=y(e,"WikiLinkPage").children[0].text.split("/").pop(),o}case"NakedURL":return e.children[0].text;case"CommandLink":{let n=y(e,"CommandLinkAlias"),o;return n?o=n.children[0].text:o=e.children[1].children[0].text,o}case"TaskState":return e.children[1].text;case"Escape":return e.children[0].text.slice(1);case"CodeText":case"Entity":return e.children[0].text;case"TemplateDirective":case"DeadlineDate":return b(e);case"CodeInfo":case"CommentBlock":case"FrontMatter":case"Hashtag":case"HardBreak":case"HorizontalRule":case"NamedAnchor":case"Attribute":return"";case void 0:return e.text;default:return console.log("Unknown tree type: ",e.type),""}}var L="outline-sidebar",B="enableOutlineSidebar";async function R(){return!!await g.get(B)}async function N(e){return await g.set(B,e)}async function k(){await l.hidePanel("rhs"),await N(!1)}async function D(){await R()?await k():await v()}async function W(){try{if(await h.getEnv()==="server")return;if(await R())return await v()}catch(e){console.error(`${L}: showOSBIfEnabled failed`,e)}}async function v(){let e={},[r]=await Promise.all([x.readAsset(L,"assets/outline-sidebar.js")]),n=await l.getCurrentPage(),o=await l.getText(),i=await P.parseMarkdown(o),a=[];if(U(i,c=>c.type?.startsWith("ATXHeading")?(a.push({name:c.children.slice(1).map(C).join("").trim(),pos:c.from,level:+c.type[c.type.length-1]}),!0):!1),a.length===0)return null;let s="",d=0;a.map((c,M,I)=>{let u=c.level;if(M===0)s+="<ul>";else if(u>d)for(let p=0;p<u-d;++p)s+="<ul>";else if(u<d)for(let p=0;p<d-u;++p)s+="</ul>";s+=`
            <li><span class="p wiki-link osb-clickable" data-osbpos="${c.pos}">${c.name}</span><li>`,M===I.length-1&&(s+="</ul>"),d=u}),await l.showPanel("rhs",.5,`
        <link rel="stylesheet" href="/.client/main.css" />
        <div id="outline-sidebar-root">
            ${s}
        </div>
        `,`
        ${r}
        `),await N(!0)}var H={showOutlineSidebar:v,hideOutlineSidebar:k,showOSBIfEnabled:W,toggle:D},K={name:"outline-sidebar",functions:{showOutlineSidebar:{path:"./outline-sidebar.ts:showOutlineSidebar"},hideOutlineSidebar:{path:"./outline-sidebar.ts:hideOutlineSidebar"},showOSBIfEnabled:{path:"./outline-sidebar.ts:showOSBIfEnabled",evnets:["editor:init","editor:pageLoaded","editor:pageSaved"]},toggle:{path:"./outline-sidebar.ts:toggleOutlineSidebar",command:{name:"Outline Sidebar: Toggle",key:"Ctrl-alt-o",mac:"Cmd-alt-o"}}},assets:{}},zr={manifest:K,functionMapping:H};E(H,K,self.postMessage);export{zr as plug};
