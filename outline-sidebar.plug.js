var W=Object.defineProperty;var g=(e,r)=>{for(var n in r)W(e,n,{get:r[n],enumerable:!0})};var p=e=>{throw new Error("Not initialized yet")},T=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var v=new Map,b=0;T&&(globalThis.syscall=async(e,...r)=>await new Promise((n,o)=>{b++,v.set(b,{resolve:n,reject:o}),p({type:"sys",id:b,name:e,args:r})}));function k(e,r,n){T&&(p=n,self.addEventListener("message",o=>{(async()=>{let i=o.data;switch(i.type){case"inv":{let a=e[i.name];if(!a)throw new Error(`Function not loaded: ${i.name}`);try{let s=await Promise.resolve(a(...i.args||[]));p({type:"invr",id:i.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",i.name,"error:",s.message),p({type:"invr",id:i.id,error:s.message})}}break;case"sysr":{let a=i.id,s=v.get(a);if(!s)throw Error("Invalid request id");v.delete(a),i.error?s.reject(new Error(i.error)):s.resolve(i.result)}break}})().catch(console.error)}),p({type:"manifest",manifest:r}))}function H(e){let r=atob(e),n=r.length,o=new Uint8Array(n);for(let i=0;i<n;i++)o[i]=r.charCodeAt(i);return o}function M(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let r="",n=e.byteLength;for(let o=0;o<n;o++)r+=String.fromCharCode(e[o]);return btoa(r)}async function K(e,r){if(typeof e!="string"){let n=new Uint8Array(await e.arrayBuffer()),o=n.length>0?M(n):void 0;r={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:o},e=e.url}return syscall("sandboxFetch.fetch",e,r)}globalThis.nativeFetch=globalThis.fetch;function I(){globalThis.fetch=async function(e,r){let n=r&&r.body?M(new Uint8Array(await new Response(r.body).arrayBuffer())):void 0,o=await K(e,r&&{method:r.method,headers:r.headers,base64Body:n});return new Response(o.base64Body?H(o.base64Body):null,{status:o.status,headers:o.headers})}}T&&I();var l={};g(l,{confirm:()=>Pe,copyToClipboard:()=>Me,deleteLine:()=>Oe,dispatch:()=>ge,downloadFile:()=>oe,filterBox:()=>ae,flashNotification:()=>se,fold:()=>be,foldAll:()=>we,getCurrentPage:()=>$,getCursor:()=>X,getSelection:()=>Q,getText:()=>q,getUiOption:()=>he,goHistory:()=>ne,hidePanel:()=>le,insertAtCursor:()=>me,insertAtPos:()=>de,moveCursor:()=>pe,moveCursorToLine:()=>fe,navigate:()=>G,newWindow:()=>te,openCommandPalette:()=>Y,openPageNavigator:()=>z,openSearchPanel:()=>ke,openUrl:()=>re,prompt:()=>ye,redo:()=>Ce,reloadConfigAndCommands:()=>ee,reloadPage:()=>J,reloadUI:()=>Z,replaceRange:()=>ue,save:()=>V,setSelection:()=>_,setText:()=>j,setUiOption:()=>xe,showPanel:()=>ce,toggleFold:()=>Te,undo:()=>Ae,unfold:()=>ve,unfoldAll:()=>Se,uploadFile:()=>ie,vimEx:()=>Ee});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function t(e,...r){return globalThis.syscall(e,...r)}function $(){return t("editor.getCurrentPage")}function q(){return t("editor.getText")}function j(e,r=!1){return t("editor.setText",e,r)}function X(){return t("editor.getCursor")}function Q(){return t("editor.getSelection")}function _(e,r){return t("editor.setSelection",e,r)}function V(){return t("editor.save")}function G(e,r=!1,n=!1){return t("editor.navigate",e,r,n)}function z(e="page"){return t("editor.openPageNavigator",e)}function Y(){return t("editor.openCommandPalette")}function J(){return t("editor.reloadPage")}function Z(){return t("editor.reloadUI")}function ee(){return t("editor.reloadConfigAndCommands")}function re(e,r=!1){return t("editor.openUrl",e,r)}function te(){return t("editor.newWindow")}function ne(e){return t("editor.goHistory",e)}function oe(e,r){return t("editor.downloadFile",e,r)}function ie(e,r){return t("editor.uploadFile",e,r)}function se(e,r="info"){return t("editor.flashNotification",e,r)}function ae(e,r,n="",o=""){return t("editor.filterBox",e,r,n,o)}function ce(e,r,n,o=""){return t("editor.showPanel",e,r,n,o)}function le(e){return t("editor.hidePanel",e)}function de(e,r){return t("editor.insertAtPos",e,r)}function ue(e,r,n){return t("editor.replaceRange",e,r,n)}function pe(e,r=!1){return t("editor.moveCursor",e,r)}function fe(e,r=1,n=!1){return t("editor.moveCursorToLine",e,r,n)}function me(e){return t("editor.insertAtCursor",e)}function ge(e){return t("editor.dispatch",e)}function ye(e,r=""){return t("editor.prompt",e,r)}function Pe(e){return t("editor.confirm",e)}function he(e){return t("editor.getUiOption",e)}function xe(e,r){return t("editor.setUiOption",e,r)}function be(){return t("editor.fold")}function ve(){return t("editor.unfold")}function Te(){return t("editor.toggleFold")}function we(){return t("editor.foldAll")}function Se(){return t("editor.unfoldAll")}function Ae(){return t("editor.undo")}function Ce(){return t("editor.redo")}function ke(){return t("editor.openSearchPanel")}function Me(e){return t("editor.copyToClipboard",e)}function Oe(){return t("editor.deleteLine")}function Ee(e){return t("editor.vimEx",e)}var y={};g(y,{parseMarkdown:()=>Fe,renderParseTree:()=>Ue});function Fe(e){return t("markdown.parseMarkdown",e)}function Ue(e){return t("markdown.renderParseTree",e)}var P={};g(P,{applyAttributeExtractors:()=>He,getEnv:()=>qe,getMode:()=>je,getSpaceConfig:()=>Ke,getVersion:()=>Xe,invokeCommand:()=>Re,invokeFunction:()=>Be,invokeSpaceFunction:()=>We,listCommands:()=>Ne,listSyscalls:()=>De,reloadConfig:()=>$e,reloadPlugs:()=>Ie});function Be(e,...r){return t("system.invokeFunction",e,...r)}function Re(e,r){return t("system.invokeCommand",e,r)}function Ne(){return t("system.listCommands")}function De(){return t("system.listSyscalls")}function We(e,...r){return t("system.invokeSpaceFunction",e,...r)}function He(e,r,n){return t("system.applyAttributeExtractors",e,r,n)}async function Ke(e,r){return await t("system.getSpaceConfig",e)??r}function Ie(){return t("system.reloadPlugs")}function $e(){return t("system.reloadConfig")}function qe(){return t("system.getEnv")}function je(){return t("system.getMode")}function Xe(){return t("system.getVersion")}var f={};g(f,{del:()=>Ve,get:()=>_e,set:()=>Qe});function Qe(e,r){return t("clientStore.set",e,r)}function _e(e){return t("clientStore.get",e)}function Ve(e){return t("clientStore.delete",e)}function w(e,r){if(r(e))return[e];let n=[];if(e.children)for(let o of e.children)n=[...n,...w(o,r)];return n}function m(e,r){return w(e,n=>n.type===r)[0]}function O(e,r){w(e,r)}function h(e){if(!e)return"";let r=[];if(e.text!==void 0)return e.text;for(let n of e.children)r.push(h(n));return r.join("")}function S(e){if(e.type?.endsWith("Mark")||e.type?.endsWith("Delimiter"))return"";let r=n=>n.map(S).join("");switch(e.type){case"Document":case"Emphasis":case"Highlight":case"Strikethrough":case"InlineCode":case"StrongEmphasis":case"Superscript":case"Subscript":case"Paragraph":case"ATXHeading1":case"ATXHeading2":case"ATXHeading3":case"ATXHeading4":case"ATXHeading5":case"ATXHeading6":case"Blockquote":case"BulletList":case"OrderedList":case"ListItem":case"Table":case"TableHeader":case"TableCell":case"TableRow":case"Task":case"HTMLTag":return r(e.children);case"FencedCode":case"CodeBlock":return e.children=e.children.filter(n=>n.type),r(e.children);case"Link":{let n=e.children.slice(1,-4);return r(n)}case"Image":{let n=m(e,"WikiLinkAlias")||e.children[1],o=n&&n.type!=="LinkMark"?h(n):"<Image>",i=/\d*[^\|\s]*?[xX]\d*[^\|\s]*/.exec(o);return i&&(o=o.replace(i[0],"").replace("|","")),o}case"WikiLink":{let n=m(e,"WikiLinkAlias"),o;return n?o=n.children[0].text:o=m(e,"WikiLinkPage").children[0].text.split("/").pop(),o}case"NakedURL":return e.children[0].text;case"CommandLink":{let n=m(e,"CommandLinkAlias"),o;return n?o=n.children[0].text:o=e.children[1].children[0].text,o}case"TaskState":return e.children[1].text;case"Escape":return e.children[0].text.slice(1);case"CodeText":case"Entity":return e.children[0].text;case"TemplateDirective":case"DeadlineDate":return h(e);case"CodeInfo":case"CommentBlock":case"FrontMatter":case"Hashtag":case"HardBreak":case"HorizontalRule":case"NamedAnchor":case"Attribute":return"";case void 0:return e.text;default:return console.log("Unknown tree type: ",e.type),""}}var cr="Outline Sidebar",E="enableOutlineSidebar";async function F(){return!!await f.get(E)}async function U(e){return await f.set(E,e)}async function A(){await l.hidePanel("rhs"),await U(!1)}async function L(){await F()?await A():await x()}async function B(){try{if(await P.getEnv()==="server")return;if(await F())return await x()}catch(e){console.error(`${cr}: showOSBIfEnabled failed`,e)}}async function x(){let e={},r=await l.getCurrentPage(),n=await l.getText(),o=await y.parseMarkdown(n),i=[];if(O(o,c=>c.type?.startsWith("ATXHeading")?(i.push({name:c.children.slice(1).map(S).join("").trim(),pos:c.from,level:+c.type[c.type.length-1]}),!0):!1),i.length===0)return null;let a="",s=0;i.map((c,C,D)=>{let d=c.level;if(console.log(d),C===0)a+="<ul>";else if(d>s)for(let u=0;u<d-s;++u)a+="<ul>";else if(d<s)for(let u=0;u<s-d;++u)a+="</ul>";a+=`
    <li><span class="p"><a href="${r}@${c.pos}" class="wiki-link" data-ref="${r}@${c.pos}">${c.name}</a></span><li>`,C===D.length-1&&(a+="</ul>"),s=d}),console.log(a),await l.showPanel("rhs",.5,`
        <div id="Outline-Sidebar">
            ${a}
        </div>
        `,""),await U(!0)}var R={showOutlineSidebar:x,hideOutlineSidebar:A,showOSBIfEnabled:B,toggle:L},N={name:"outline-sidebar",functions:{showOutlineSidebar:{path:"./outline-sidebar.ts:showOutlineSidebar"},hideOutlineSidebar:{path:"./outline-sidebar.ts:hideOutlineSidebar"},showOSBIfEnabled:{path:"./outline-sidebar.ts:showOSBIfEnabled",evnets:["editor:init","editor:pageLoaded","editor:pageSaved"]},toggle:{path:"./outline-sidebar.ts:toggleOutlineSidebar",command:{name:"Outline Sidebar: Toggle",key:"Ctrl-alt-o",mac:"Cmd-alt-o"}}},assets:{}},_r={manifest:N,functionMapping:R};k(R,N,self.postMessage);export{_r as plug};
