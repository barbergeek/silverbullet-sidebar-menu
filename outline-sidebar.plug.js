var D=Object.defineProperty;var p=(e,t)=>{for(var n in t)D(e,n,{get:t[n],enumerable:!0})};var m=e=>{throw new Error("Not initialized yet")},C=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var T=new Map,v=0;C&&(globalThis.syscall=async(e,...t)=>await new Promise((n,o)=>{v++,T.set(v,{resolve:n,reject:o}),m({type:"sys",id:v,name:e,args:t})}));function O(e,t,n){C&&(m=n,self.addEventListener("message",o=>{(async()=>{let i=o.data;switch(i.type){case"inv":{let a=e[i.name];if(!a)throw new Error(`Function not loaded: ${i.name}`);try{let s=await Promise.resolve(a(...i.args||[]));m({type:"invr",id:i.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",i.name,"error:",s.message),m({type:"invr",id:i.id,error:s.message})}}break;case"sysr":{let a=i.id,s=T.get(a);if(!s)throw Error("Invalid request id");T.delete(a),i.error?s.reject(new Error(i.error)):s.resolve(i.result)}break}})().catch(console.error)}),m({type:"manifest",manifest:t}))}function K(e){let t=atob(e),n=t.length,o=new Uint8Array(n);for(let i=0;i<n;i++)o[i]=t.charCodeAt(i);return o}function F(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",n=e.byteLength;for(let o=0;o<n;o++)t+=String.fromCharCode(e[o]);return btoa(t)}async function U(e,t){if(typeof e!="string"){let n=new Uint8Array(await e.arrayBuffer()),o=n.length>0?F(n):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:o},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function G(){globalThis.fetch=async function(e,t){let n=t&&t.body?F(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,o=await U(e,t&&{method:t.method,headers:t.headers,base64Body:n});return new Response(o.base64Body?K(o.base64Body):null,{status:o.status,headers:o.headers})}}C&&G();var l={};p(l,{confirm:()=>Te,copyToClipboard:()=>Le,deleteLine:()=>Ne,dispatch:()=>be,downloadFile:()=>le,filterBox:()=>pe,flashNotification:()=>de,fold:()=>Ae,foldAll:()=>ke,getCurrentPage:()=>H,getCurrentPageMeta:()=>V,getCursor:()=>q,getSelection:()=>J,getText:()=>Y,getUiOption:()=>Ce,goHistory:()=>ce,hidePanel:()=>fe,insertAtCursor:()=>he,insertAtPos:()=>ge,moveCursor:()=>xe,moveCursorToLine:()=>Pe,moveLineDown:()=>Ee,moveLineUp:()=>Be,navigate:()=>z,newWindow:()=>ae,openCommandPalette:()=>te,openPageNavigator:()=>ee,openSearchPanel:()=>We,openUrl:()=>se,prompt:()=>ve,rebuildEditorState:()=>oe,redo:()=>Me,reloadConfigAndCommands:()=>ie,reloadPage:()=>re,reloadUI:()=>ne,replaceRange:()=>ye,save:()=>$,setSelection:()=>_,setText:()=>X,setUiOption:()=>we,showPanel:()=>me,toggleFold:()=>Ie,undo:()=>Fe,unfold:()=>Se,unfoldAll:()=>Oe,uploadFile:()=>ue,vimEx:()=>Re});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function r(e,...t){return globalThis.syscall(e,...t)}function H(){return r("editor.getCurrentPage")}function V(){return r("editor.getCurrentPageMeta")}function Y(){return r("editor.getText")}function X(e,t=!1){return r("editor.setText",e,t)}function q(){return r("editor.getCursor")}function J(){return r("editor.getSelection")}function _(e,t){return r("editor.setSelection",e,t)}function $(){return r("editor.save")}function z(e,t=!1,n=!1){return r("editor.navigate",e,t,n)}function ee(e="page"){return r("editor.openPageNavigator",e)}function te(){return r("editor.openCommandPalette")}function re(){return r("editor.reloadPage")}function ne(){return r("editor.reloadUI")}function oe(){return r("editor.rebuildEditorState")}function ie(){return r("editor.reloadConfigAndCommands")}function se(e,t=!1){return r("editor.openUrl",e,t)}function ae(){return r("editor.newWindow")}function ce(e){return r("editor.goHistory",e)}function le(e,t){return r("editor.downloadFile",e,t)}function ue(e,t){return r("editor.uploadFile",e,t)}function de(e,t="info"){return r("editor.flashNotification",e,t)}function pe(e,t,n="",o=""){return r("editor.filterBox",e,t,n,o)}function me(e,t,n,o=""){return r("editor.showPanel",e,t,n,o)}function fe(e){return r("editor.hidePanel",e)}function ge(e,t){return r("editor.insertAtPos",e,t)}function ye(e,t,n){return r("editor.replaceRange",e,t,n)}function xe(e,t=!1){return r("editor.moveCursor",e,t)}function Pe(e,t=1,n=!1){return r("editor.moveCursorToLine",e,t,n)}function he(e,t=!1){return r("editor.insertAtCursor",e,t)}function be(e){return r("editor.dispatch",e)}function ve(e,t=""){return r("editor.prompt",e,t)}function Te(e){return r("editor.confirm",e)}function Ce(e){return r("editor.getUiOption",e)}function we(e,t){return r("editor.setUiOption",e,t)}function Ae(){return r("editor.fold")}function Se(){return r("editor.unfold")}function Ie(){return r("editor.toggleFold")}function ke(){return r("editor.foldAll")}function Oe(){return r("editor.unfoldAll")}function Fe(){return r("editor.undo")}function Me(){return r("editor.redo")}function We(){return r("editor.openSearchPanel")}function Le(e){return r("editor.copyToClipboard",e)}function Ne(){return r("editor.deleteLine")}function Be(){return r("editor.moveLineUp")}function Ee(){return r("editor.moveLineDown")}function Re(e){return r("editor.vimEx",e)}var P={};p(P,{parseMarkdown:()=>je,renderParseTree:()=>Qe});function je(e){return r("markdown.parseMarkdown",e)}function Qe(e){return r("markdown.renderParseTree",e)}var f={};p(f,{applyAttributeExtractors:()=>Ve,getEnv:()=>Je,getMode:()=>_e,getSpaceConfig:()=>Ye,getVersion:()=>$e,invokeCommand:()=>Ke,invokeFunction:()=>De,invokeSpaceFunction:()=>He,listCommands:()=>Ue,listSyscalls:()=>Ge,reloadConfig:()=>qe,reloadPlugs:()=>Xe});function De(e,...t){return r("system.invokeFunction",e,...t)}function Ke(e,t){return r("system.invokeCommand",e,t)}function Ue(){return r("system.listCommands")}function Ge(){return r("system.listSyscalls")}function He(e,...t){return r("system.invokeSpaceFunction",e,...t)}function Ve(e,t,n){return r("system.applyAttributeExtractors",e,t,n)}async function Ye(e,t){return await r("system.getSpaceConfig",e)??t}function Xe(){return r("system.reloadPlugs")}function qe(){return r("system.reloadConfig")}function Je(){return r("system.getEnv")}function _e(){return r("system.getMode")}function $e(){return r("system.getVersion")}var g={};p(g,{del:()=>tt,get:()=>et,set:()=>ze});function ze(e,t){return r("clientStore.set",e,t)}function et(e){return r("clientStore.get",e)}function tt(e){return r("clientStore.delete",e)}var y={};p(y,{getFileMeta:()=>ut,listFiles:()=>lt,readAsset:()=>ct});function at(e){let t=atob(e),n=t.length,o=new Uint8Array(n);for(let i=0;i<n;i++)o[i]=t.charCodeAt(i);return o}function M(e){let t=e.split(",",2)[1];return at(t)}async function ct(e,t,n="utf8"){let o=await r("asset.readAsset",e,t);switch(n){case"utf8":return new TextDecoder().decode(M(o));case"dataurl":return o}}async function lt(e){return await r("asset.listFiles",e)}async function ut(e,t){return await r("asset.getFileMeta",e,t)}function w(e,t){if(t(e))return[e];let n=[];if(e.children)for(let o of e.children)n=[...n,...w(o,t)];return n}function x(e,t){return w(e,n=>n.type===t)[0]}function W(e,t){w(e,t)}function h(e){if(!e)return"";let t=[];if(e.text!==void 0)return e.text;for(let n of e.children)t.push(h(n));return t.join("")}function A(e){if(e.type?.endsWith("Mark")||e.type?.endsWith("Delimiter"))return"";let t=n=>n.map(A).join("");switch(e.type){case"Document":case"Emphasis":case"Highlight":case"Strikethrough":case"InlineCode":case"StrongEmphasis":case"Superscript":case"Subscript":case"Paragraph":case"ATXHeading1":case"ATXHeading2":case"ATXHeading3":case"ATXHeading4":case"ATXHeading5":case"ATXHeading6":case"Blockquote":case"BulletList":case"OrderedList":case"ListItem":case"Table":case"TableHeader":case"TableCell":case"TableRow":case"Task":case"HTMLTag":return t(e.children);case"FencedCode":case"CodeBlock":return e.children=e.children.filter(n=>n.type),t(e.children);case"Link":{let n=e.children.slice(1,-4);return t(n)}case"Image":{let n=x(e,"WikiLinkAlias")||e.children[1],o=n&&n.type!=="LinkMark"?h(n):"<Image>",i=/\d*[^\|\s]*?[xX]\d*[^\|\s]*/.exec(o);return i&&(o=o.replace(i[0],"").replace("|","")),o}case"WikiLink":{let n=x(e,"WikiLinkAlias"),o;return n?o=n.children[0].text:o=x(e,"WikiLinkPage").children[0].text.split("/").pop(),o}case"NakedURL":return e.children[0].text;case"CommandLink":{let n=x(e,"CommandLinkAlias"),o;return n?o=n.children[0].text:o=e.children[1].children[0].text,o}case"TaskState":return e.children[1].text;case"Escape":return e.children[0].text.slice(1);case"CodeText":case"Entity":return e.children[0].text;case"TemplateDirective":case"DeadlineDate":return h(e);case"CodeInfo":case"CommentBlock":case"FrontMatter":case"Hashtag":case"HardBreak":case"HorizontalRule":case"NamedAnchor":case"Attribute":return"";case void 0:return e.text;default:return console.log("Unknown tree type: ",e.type),""}}var S="outline-sidebar",L="enableOutlineSidebar";async function N(){return!!await g.get(L)}async function B(e){return await g.set(L,e)}async function I(){await l.hidePanel("rhs"),await B(!1)}async function E(){await N()?await I():await b()}async function R(){try{if((await f.getVersion()).includes("0.10")&&await f.getEnv()==="server")return;if(await N())return await b()}catch(e){console.error(`${S}: showOSBIfEnabled failed`,e)}}async function b(){await l.hidePanel("rhs");let[e,t]=await Promise.all([y.readAsset(S,"assets/outline-sidebar.css"),y.readAsset(S,"assets/outline-sidebar.js")]),n=await l.getText(),o=await P.parseMarkdown(n),i=[];if(W(o,c=>c.type?.startsWith("ATXHeading")?(i.push({name:c.children.slice(1).map(A).join("").trim(),pos:c.from,level:+c.type[c.type.length-1]}),!0):!1),i.length===0)return null;let a="",s=0;i.map((c,k,Z)=>{let u=c.level;if(k===0)a+="<ul>";else if(u>s)for(let d=0;d<u-s;++d)a+="<ul>";else if(u<s)for(let d=0;d<s-u;++d)a+="</ul>";a+=`
            <li><span class="p wiki-link osb-clickable" data-osbpos="${c.pos}">${c.name}</span></li>`,k===Z.length-1&&(a+="</ul>"),s=u}),await l.showPanel("rhs",.5,`
        <link rel="stylesheet" href="/.client/main.css" />
        <style>
        ${e}
        </style>
        <div id="outline-sidebar-root">
            ${a}
        </div>
        `,`
        ${t}
        addClickEvent()
        `),await B(!0)}var j={showOutlineSidebar:b,hideOutlineSidebar:I,showOSBIfEnabled:R,toggle:E},Q={name:"outline-sidebar",assets:{"assets/outline-sidebar.css":{data:"data:text/css;base64,I291dGxpbmUtc2lkZWJhci1yb290IHsNCiAgICBmb250LWZhbWlseTogdmFyKC0tZWRpdG9yLWZvbnQpOw0KICAgIGZvbnQtc2l6ZTogMC44NXJlbTsNCn0NCg0KI291dGxpbmUtc2lkZWJhci1yb290IHVsIHsNCiAgICBsaXN0LXN0eWxlOiBub25lOw0KICAgIHBhZGRpbmctaW5saW5lLXN0YXJ0OiAxNnB4Ow0KfQ0KDQojb3V0bGluZS1zaWRlYmFyLXJvb3QgbGk6OmJlZm9yZSB7DQogICAgY29udGVudDogIlwyQjlFIjsNCiAgICBjb2xvcjogdmFyKC0tZWRpdG9yLWxpc3QtYnVsbGV0LWNvbG9yKTsNCiAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7DQogICAgd2lkdGg6IDFlbTsNCiAgICBtYXJnaW4tbGVmdDogLTFlbTsNCn0NCg0KI291dGxpbmUtc2lkZWJhci1yb290IHNwYW4ub3NiLWNsaWNrYWJsZTpob3ZlciB7DQogICAgY3Vyc29yOiBwb2ludGVyOw0KfQ0KDQojb3V0bGluZS1zaWRlYmFyLXJvb3Qgc3Bhbi5vc2ItY2xpY2thYmxlIHsNCiAgICBib3JkZXItcmFkaXVzOiA1cHg7DQogICAgcGFkZGluZzogMCA1cHg7DQogICAgY29sb3I6IHZhcigtLWVkaXRvci13aWtpLWxpbmstcGFnZS1jb2xvcik7DQogICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tZWRpdG9yLXdpa2ktbGluay1wYWdlLWJhY2tncm91bmQtY29sb3IpOw0KICAgIHRleHQtZGVjb3JhdGlvbjogbm9uZTsNCn0NCg==",mtime:1743681730125},"assets/outline-sidebar.js":{data:"data:application/javascript;base64,Ly8gZGVuby1saW50LWlnbm9yZSBuby11bnVzZWQtdmFycw0KZnVuY3Rpb24gYWRkQ2xpY2tFdmVudCgpIHsNCiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCJbZGF0YS1vc2Jwb3NdIikuZm9yRWFjaCgoZWwpID0+IHsNCiAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoZSkgPT4gew0KICAgICAgICAgICAgY29uc3QgcG9zID0gcGFyc2VJbnQoZWwuZGF0YXNldC5vc2Jwb3MpDQogICAgICAgICAgICBzeXNjYWxsKCJlZGl0b3IubW92ZUN1cnNvciIsIHBvcywgdHJ1ZSkNCiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCkNCiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKQ0KICAgICAgICB9KQ0KICAgIH0pDQp9DQo=",mtime:1743681730125}},functions:{showOutlineSidebar:{path:"./outline-sidebar.ts:showOutlineSidebar"},hideOutlineSidebar:{path:"./outline-sidebar.ts:hideOutlineSidebar"},showOSBIfEnabled:{path:"./outline-sidebar.ts:showOSBIfEnabled",events:["editor:init","editor:updated","editor:pageLoaded","editor:pageReloaded"]},toggle:{path:"./outline-sidebar.ts:toggleOutlineSidebar",command:{name:"Outline Sidebar: Toggle",key:"Ctrl-alt-o",mac:"Cmd-alt-o"}}}},nr={manifest:Q,functionMapping:j};O(j,Q,self.postMessage);export{nr as plug};
